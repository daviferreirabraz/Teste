name: Windows Cloud PC - UE5 Attempt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Instalar Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
          Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/quiet", "/norestart" -Wait

      - name: Conectar ao Tailscale
        shell: powershell
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TS_AUTHKEY --hostname="ue5-test-pc" --unattended

      - name: Configurar Usuario e RDP (Sem NLA)
        shell: powershell
        run: |
          $Password = ConvertTo-SecureString "SenhaUE5@123" -AsPlainText -Force
          New-LocalUser "ue5user" -Password $Password
          Add-LocalGroupMember -Group "Administrators" -Member "ue5user"
          (Get-WmiObject -class "Win32_TSGeneralSetting" -Namespace root\cimv2\terminalservices -Filter "TerminalName='RDP-Tcp'").SetUserAuthenticationRequired(0)
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

      - name: Tentar Instalar Epic Games Launcher
        shell: powershell
        run: |
          Write-Host "Baixando Epic Games Launcher..."
          # O winget vai tentar instalar, mas pode falhar por falta de espa√ßo no meio do processo
          winget install --id EpicGames.EpicGamesLauncher --silent --accept-package-agreements

      - name: Mostrar IP e Manter Online
        shell: powershell
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "-------------------------------------------"
          Write-Host "IP: $ip"
          Write-Host "USUARIO: ue5user"
          Write-Host "SENHA: SenhaUE5@123"
          Write-Host "-------------------------------------------"
          Start-Sleep -Seconds 21600
