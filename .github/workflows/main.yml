name: Windows Cloud PC Estavel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest # Máquina com ~7GB RAM livre
    steps:
      - name: Instalar Tailscale
        shell: powershell
        run: |
          Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile tailscale-setup.exe
          Start-Process -FilePath "tailscale-setup.exe" -ArgumentList "/quiet", "/norestart" -Wait

      - name: Conectar ao Tailscale
        shell: powershell
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TS_AUTHKEY --hostname="pc-estavel" --unattended

      - name: Configurar Acesso e Usuario
        shell: powershell
        run: |
          # Cria o usuário 'admin' com senha padrão
          $Password = ConvertTo-SecureString "Senha@123456" -AsPlainText -Force
          New-LocalUser "admin" -Password $Password -Description "Admin User"
          Add-LocalGroupMember -Group "Administrators" -Member "admin"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "admin"

          # DESATIVA O NLA (Isso resolve o erro de login do Windows App)
          $ts = Get-WmiObject -Class "Win32_TSGeneralSetting" -Namespace root\cimv2\terminalservices -Filter "TerminalName='RDP-Tcp'"
          $ts.SetUserAuthenticationRequired(0)

          # Abre o Firewall para RDP
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

      - name: Mostrar Dados de Conexão
        shell: powershell
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "-------------------------------------------"
          Write-Host "IP: $ip"
          Write-Host "USUARIO: admin"
          Write-Host "SENHA: Senha@123456"
          Write-Host "-------------------------------------------"
          Start-Sleep -Seconds 21600 # Fica ligado por 6 horas
